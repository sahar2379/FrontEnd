<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرم انتخاب لوکیشن از روی نقشه</title>
    <!-- لینک به CSS بوت‌استرپ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- لینک به CSS Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 400px; /* ارتفاع مشخص برای نمایش نقشه */
            width: 100%; /* عرض کامل */
        }

        /* اضافه کردن گردی به دکمه از چهار طرف */
        .btn-rounded {
            border-radius: 15px;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2 class="text-center">فرم اصلی</h2>
    <!-- فرم اصلی -->
    <form id="mainForm">
        <div class="mb-3">
            <label for="name" class="form-label">نام:</label>
            <input type="text" class="form-control" id="name" placeholder="نام خود را وارد کنید">
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">ایمیل:</label>
            <input type="email" class="form-control" id="email" placeholder="ایمیل خود را وارد کنید">
        </div>
        <!-- فیلد مخفی برای ذخیره مختصات انتخابی -->
        <input type="hidden" id="savedLocation" name="location">
        
        <!-- فیلد برای نمایش مختصات ذخیره‌شده و دکمه انتخاب لوکیشن کنار آن -->
        <div class="mb-3">
            <label for="selectedLocation" class="form-label">مختصات ذخیره‌شده:</label>
            <div class="input-group">
                <input type="text" class="form-control" id="selectedLocation" placeholder="مختصات ذخیره شده" readonly>
                <button type="button" class="btn btn-primary btn-rounded" data-bs-toggle="modal" data-bs-target="#locationModal">
                    انتخاب لوکیشن از روی نقشه
                </button>
            </div>
        </div>
    </form>
</div>

<!-- مودال انتخاب لوکیشن -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">انتخاب لوکیشن از روی نقشه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <!-- جستجوی مکان -->
                <div class="mb-3">
                    <label for="searchLocation" class="form-label">جستجوی شهر یا منطقه:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchLocation" placeholder="نام شهر یا منطقه را وارد کنید">
                        <button type="button" class="btn btn-secondary" id="searchBtn">جستجو</button>
                    </div>
                </div>
                <!-- نقشه -->
                <div id="map"></div>
                <!-- نمایش مختصات انتخابی -->
                <div class="mt-3">
                    <label for="location" class="form-label">مختصات انتخابی:</label>
                    <input type="text" class="form-control" id="location" placeholder="مختصات در اینجا نمایش داده می‌شود" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                <button type="button" class="btn btn-primary" id="saveLocationBtn">ذخیره لوکیشن</button>
            </div>
        </div>
    </div>
</div>

<!-- لینک به جاوااسکریپت بوت‌استرپ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- لینک به جاوااسکریپت Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    var map;
    var marker;

    // تنظیمات نقشه
    function initializeMap() {
        map = L.map('map').setView([35.6892, 51.3890], 13); // موقعیت پیش‌فرض: تهران

        // بارگذاری نقشه از OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // اضافه کردن قابلیت کلیک روی نقشه برای انتخاب مکان
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            // اگر مارکر از قبل وجود دارد، حذف شود
            if (marker) {
                map.removeLayer(marker);
            }

            // ایجاد یک مارکر جدید در محل کلیک
            marker = L.marker([lat, lng]).addTo(map);

            // ثبت مختصات در ورودی
            document.getElementById('location').value = lat + ', ' + lng;
        });
    }

    // وقتی مودال باز شد، نقشه را رفرش کن
    var locationModal = document.getElementById('locationModal');
    locationModal.addEventListener('shown.bs.modal', function () {
        if (!map) {
            initializeMap(); // نقشه برای اولین بار ساخته می‌شود
        } else {
            map.invalidateSize(); // رفرش نقشه برای اطمینان از نمایش درست
        }
    });

    // جستجوی مکان با استفاده از Nominatim API
    document.getElementById('searchBtn').addEventListener('click', function () {
        var locationName = document.getElementById('searchLocation').value;
        if (locationName) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${locationName}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var lat = data[0].lat;
                    var lon = data[0].lon;

                    // حرکت به مکان پیدا شده روی نقشه
                    map.setView([lat, lon], 13);

                    // اضافه کردن مارکر
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([lat, lon]).addTo(map);

                    // ثبت مختصات در ورودی
                    document.getElementById('location').value = lat + ', ' + lon;
                } else {
                    alert("مکانی یافت نشد");
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        } else {
            alert("لطفاً نام شهر یا منطقه را وارد کنید");
        }
    });

    // ذخیره مختصات
    document.getElementById('saveLocationBtn').addEventListener('click', function () {
        // گرفتن مختصات از فیلد مربوطه
        var selectedLocation = document.getElementById('location').value;
        
        // ذخیره مختصات در فیلد مخفی فرم اصلی
        document.getElementById('savedLocation').value = selectedLocation;
        
        // نمایش مختصات در فیلد خواندنی فرم اصلی
        document.getElementById('selectedLocation').value = selectedLocation;
        
        // بستن مودال
        var locationModalEl = document.getElementById('locationModal');
        var modalInstance = bootstrap.Modal.getInstance(locationModalEl);
        modalInstance.hide();
    });

</script>

</body>
</html>
